# Project 5 — Argo CD ApplicationSet GitOps Deployment

![Project 5 Architecture](docs/images/project5-architecture.svg)

This project extends the GitOps deployment model from earlier projects by introducing **Argo CD ApplicationSets**, enabling automated multi‑environment deployments (dev and prod) from a single declarative configuration source.

Project 5 integrates:

- **Project 1** → CI builds & updates image tags  
- **Project 4** → Helm chart source for the application  
- **Project 5** → GitOps configuration repo using Argo CD ApplicationSets  
- **Argo CD** → Automated pull‑based deployments  

This project demonstrates real‑world GitOps patterns used in production Kubernetes platforms.

---

## 1. Repository Structure

```
project5-argocd-applicationset/
│
├── applications/
│   └── project5-applicationsets-app.yaml      # Argo CD “meta-application”
│
├── applicationsets/
│   └── project5-applicationset.yaml           # ApplicationSets (dev + prod)
│
├── docs/
│   ├── architecture.md
│   ├── applicationset-design.md
│   ├── argo-cd-configuration.md
│   ├── cicd-integration.md
│   ├── dev-prod-lifecycle.md
│   ├── references.md
│   └── images/
│       └── project5-architecture.svg
│
└── environments/
    ├── dev/
    │   └── values-dev.yaml                    # Placeholder (not wired yet)
    └── prod/
        └── values-prod.yaml                   # Placeholder (not wired yet)
```

For more detailed architectural explanation, see  
**docs/architecture.md**

---

## 2. Deployment Flow (High-Level)

1. A developer pushes code to **Project 1** on the `project5-gitops` branch.  
2. GitHub Actions builds the Docker image and pushes it to Amazon ECR.  
3. The pipeline checks out this repository (Project 5) and updates the **dev ApplicationSet image tag**.  
4. Argo CD detects the change via the meta‑application (`project5-applicationsets-app`) and **auto-syncs** the ApplicationSet.  
5. The ApplicationSet controller regenerates:
   - `project5-dev` (auto-sync enabled)
   - `project5-prod` (manual sync)
6. Argo CD deploys the dev environment automatically.  
7. Production changes are applied only after a **manual sync** in the Argo CD UI.

This creates a clear and predictable workflow:
- **Continuous deployment** to dev  
- **Controlled promotion** to prod  

---

## 3. ApplicationSet Overview

The core of this repository is the **ApplicationSet** located in:

```
applicationsets/project5-applicationset.yaml
```

It contains two ApplicationSets:

- **project5-dev**  
  - Auto-sync enabled  
  - Replica count = 1  
  - Updates automatically when CI updates `image.tag`

- **project5-prod**  
  - Manual sync (approval required)  
  - Same chart and structure as dev  
  - Replica count = 1  

### Key Components

| Field | Purpose |
|-------|---------|
| `generators.list` | Defines the list of environments (dev, prod) |
| `template.metadata.name` | Sets the generated Argo CD Application name |
| `template.spec.source` | Points to Project 4 Helm chart |
| `template.spec.source.helm.parameters` | Injects image.tag, replicaCount, etc. |
| `syncPolicy` | Dev = automated, Prod = manual |
| `syncOptions.CreateNamespace=true` | Automatically creates namespaces |

Each generated Application deploys the Helm chart at:

```
repoURL: https://github.com/theseanchristopher/project4-helm-argo-gitops.git
targetRevision: project4-gitops
path: charts/app
```

---

## 4. Environment Differences

### **Dev Environment**
- Auto-sync enabled  
- 1 replica  
- Immediate updates when `image.tag` changes  
- URL (example):  
  ```
  https://project5-dev.seanxtopher.com
  ```

### **Prod Environment**
- Manual sync  
- 1 replica (can be scaled in future)  
- Used for controlled promotion  
- URL (example):  
  ```
  https://project5-prod.seanxtopher.com
  ```

---

## 5. Argo CD Applications

Project 5 uses a **meta-application** to manage its ApplicationSets.

### `project5-applicationsets-app`
Located in:

```
applications/project5-applicationsets-app.yaml
```

Purpose:
- Watches this repository (`path: applicationsets`)
- Automatically applies ApplicationSets when changes occur
- Ensures ApplicationSets are the single source of truth for dev & prod deployments

### `project5-dev`
- Generated by ApplicationSet  
- Auto-sync enabled  
- Deploys application via Project 4 Helm chart  
- Receives new images on every successful CI run  

### `project5-prod`
- Generated by ApplicationSet  
- Manual sync  
- Used to demonstrate gated promotion  

---

## 6. CI/CD Integration (From Project 1)

The GitHub Actions workflow in Project 1:

1. Builds the Docker image  
2. Pushes to ECR  
3. Updates this repo (`project5-argocd-applicationset`) by modifying:  
   ```
   applicationsets/project5-applicationset.yaml
   ```
   Specifically the `image.tag` value for the **dev** environment.

Argo CD then:

- Detects the commit  
- Syncs the ApplicationSet  
- Deploys to `project5-dev`  

Production tagging requires **manual promotion**.

---

## 7. Dev → Prod Promotion Workflow

1. Developer pushes changes → CI builds image → Dev updates automatically  
2. Review dev environment in Argo CD or via app URL  
3. Sync `project5-prod` in Argo CD to promote  
4. Prod deploys the SAME Helm chart + parameters as dev, but using the updated tag  

This mirrors real enterprise GitOps promotion models.

---

## 8. Why ApplicationSets?

ApplicationSets enable:

- Consistent, scalable multi-environment GitOps  
- Reduced duplication compared to separate Argo apps  
- Centralized environment definitions  
- Declarative environment management  
- CI-driven dynamic updates (e.g., `image.tag`)  

This pattern is used by platform engineering teams to manage dozens—or hundreds—of environment variations.

---

## 9. Namespace Strategy

Project 5 deploys to:

```
project5-dev
project5-prod
```

Namespaces are automatically created via:

```
syncOptions:
  - CreateNamespace=true
```

This ensures environments are reproducible and self-contained.

---

## 10. Why ApplicationSets Matter

ApplicationSets are a core capability for scaling GitOps across multiple environments.  
They enable:

- Declarative multi-environment management  
- Reduction of YAML duplication  
- Automated generation of Argo CD Applications  
- Consistent structure across dev, staging, and production  
- CI-driven updates without modifying Helm charts  
- A clean separation of CI (image building) and CD (Argo CD pulling state)

Project 5 demonstrates how platform engineering teams manage tens or hundreds of deployments using a single source-of-truth pattern.

---

## 11. Summary

Project 5 provides:

- A complete **ApplicationSet-based GitOps workflow**
- Automated multi-environment deployments
- CI-driven updates via Project 1
- Unified configuration for dev and prod
- Enterprise-ready Argo CD patterns
- A clean dev → prod promotion lifecycle

This project demonstrates how Argo CD ApplicationSets can be used to scale GitOps across multiple environments in real-world Kubernetes platforms.

**Note:** Screenshots of the Argo CD UI and ApplicationSet behavior may be added in the future to complement the existing documentation.

